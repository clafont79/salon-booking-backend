<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="cancel()" [disabled]="loading">
        {{ viewOnly ? 'Chiudi' : 'Annulla' }}
      </ion-button>
    </ion-buttons>
    <ion-title>{{ viewOnly ? 'Dettagli Operatore' : (operator ? 'Modifica Operatore' : 'Nuovo Operatore') }}</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="viewOnly && operator" (click)="switchToEditMode()" color="light">
        <ion-icon slot="start" name="create-outline"></ion-icon>
        Modifica
      </ion-button>
      <ion-button *ngIf="!viewOnly" (click)="save()" [strong]="true" [disabled]="loading || operatorForm.invalid">
        {{ operator ? 'Aggiorna' : 'Salva' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="operatorForm">
    <ion-list>
      <ion-item>
        <ion-label position="stacked">Utente <ion-text color="danger">*</ion-text></ion-label>
        <ion-select formControlName="userId" placeholder="Seleziona un utente" [disabled]="!!operator">
          <ion-select-option *ngFor="let user of users" [value]="user._id">
            {{ getUserLabel(user) }}
          </ion-select-option>
        </ion-select>
      </ion-item>
      
      <ion-item *ngIf="!operator && users.length === 0 && !loading" lines="none">
        <ion-label color="medium" class="ion-text-center">
          <p>
            <ion-icon name="information-circle-outline" style="vertical-align: middle;"></ion-icon>
            Nessun utente disponibile. Tutti gli operatori sono già stati assegnati.
          </p>
        </ion-label>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Specializzazioni <ion-text color="danger">*</ion-text></ion-label>
        <ion-select 
          formControlName="specializzazioni" 
          placeholder="Seleziona specializzazioni"
          multiple="true">
          <ion-select-option *ngFor="let spec of specializzazioni" [value]="spec">
            {{ spec }}
          </ion-select-option>
        </ion-select>
      </ion-item>
      
      <ion-item *ngIf="selectedSpecializzazioni && selectedSpecializzazioni.length > 0">
        <ion-label>
          <p class="selected-specs">
            <ion-chip *ngFor="let spec of selectedSpecializzazioni" [color]="spec === 'Altro...' ? 'warning' : 'primary'">
              <ion-label>{{ spec }}</ion-label>
            </ion-chip>
          </p>
        </ion-label>
      </ion-item>
      
      <ion-item *ngIf="hasCustomSpecializzazione">
        <ion-label position="stacked">Aggiungi specializzazione personalizzata</ion-label>
        <ion-input 
          [(ngModel)]="customSpecializzazione"
          [ngModelOptions]="{standalone: true}"
          [disabled]="viewOnly"
          placeholder="Inserisci specializzazione"
          type="text">
        </ion-input>
        <ion-button slot="end" fill="clear" (click)="addCustomSpecializzazione()" [disabled]="!customSpecializzazione || viewOnly">
          <ion-icon name="add-circle"></ion-icon>
        </ion-button>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Descrizione</ion-label>
        <ion-textarea 
          formControlName="descrizione" 
          placeholder="Breve descrizione dei servizi offerti..."
          rows="3">
        </ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Colore Identificativo <ion-text color="danger">*</ion-text></ion-label>
        <ion-select formControlName="colore" placeholder="Seleziona un colore">
          <ion-select-option *ngFor="let colore of colori" [value]="colore.valore">
            <div style="display: flex; align-items: center;">
              <span [style.background-color]="colore.valore" style="width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-right: 10px;"></span>
              {{ colore.nome }}
            </div>
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>Operatore Attivo</ion-label>
        <ion-toggle formControlName="attivo" slot="end"></ion-toggle>
      </ion-item>
    </ion-list>

    <div class="color-preview" *ngIf="operatorForm.get('colore')?.value">
      <p>Anteprima colore:</p>
      <div class="avatar-preview" [style.background-color]="operatorForm.get('colore')?.value">
        <span>{{ operatorForm.get('specializzazioni')?.value?.[0]?.charAt(0) || '?' }}</span>
      </div>
    </div>

    <!-- Sezione Disponibilità -->
    <ion-list-header>
      <ion-label>
        <h2>Disponibilità Settimanale</h2>
        <p>Imposta gli orari di lavoro per ogni giorno della settimana</p>
      </ion-label>
    </ion-list-header>

    <ion-list>
      <div *ngFor="let slot of disponibilita; let i = index" class="availability-slot">
        <ion-item-divider>
          <ion-label>Fascia {{ i + 1 }}</ion-label>
          <ion-button fill="clear" color="danger" slot="end" (click)="removeSlot(i)" *ngIf="!viewOnly">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item-divider>

        <ion-item>
          <ion-label position="stacked">Giorni della Settimana <ion-text color="danger">*</ion-text></ion-label>
          <ion-select 
            [(ngModel)]="slot.giorni" 
            [ngModelOptions]="{standalone: true}" 
            [disabled]="viewOnly"
            placeholder="Seleziona giorni"
            multiple="true">
            <ion-select-option value="lunedi">Lunedì</ion-select-option>
            <ion-select-option value="martedi">Martedì</ion-select-option>
            <ion-select-option value="mercoledi">Mercoledì</ion-select-option>
            <ion-select-option value="giovedi">Giovedì</ion-select-option>
            <ion-select-option value="venerdi">Venerdì</ion-select-option>
            <ion-select-option value="sabato">Sabato</ion-select-option>
            <ion-select-option value="domenica">Domenica</ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item *ngIf="slot.giorni && slot.giorni.length > 0" class="selected-days">
          <ion-label>
            <p class="days-preview">{{ formatSelectedDays(slot.giorni) }}</p>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Ora Inizio <ion-text color="danger">*</ion-text></ion-label>
          <ion-datetime-button datetime="start-{{i}}" [disabled]="viewOnly"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="start-{{i}}"
                presentation="time"
                [(ngModel)]="slot.oraInizio"
                [ngModelOptions]="{standalone: true}"
                [disabled]="viewOnly"
                [hourCycle]="'h23'">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Ora Fine <ion-text color="danger">*</ion-text></ion-label>
          <ion-datetime-button datetime="end-{{i}}" [disabled]="viewOnly"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="end-{{i}}"
                presentation="time"
                [(ngModel)]="slot.oraFine"
                [ngModelOptions]="{standalone: true}"
                [disabled]="viewOnly"
                [hourCycle]="'h23'">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </ion-item>

        <ion-item>
          <ion-label>Pausa Pranzo</ion-label>
          <ion-toggle [(ngModel)]="slot.pausaPranzo" [ngModelOptions]="{standalone: true}" [disabled]="viewOnly" slot="end"></ion-toggle>
        </ion-item>

        <div *ngIf="slot.pausaPranzo" class="pause-section">
          <ion-item>
            <ion-label position="stacked">Inizio Pausa</ion-label>
            <ion-datetime-button datetime="pause-start-{{i}}" [disabled]="viewOnly"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime 
                  id="pause-start-{{i}}"
                  presentation="time"
                  [(ngModel)]="slot.inizioPausa"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="viewOnly"
                  [hourCycle]="'h23'">
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Fine Pausa</ion-label>
            <ion-datetime-button datetime="pause-end-{{i}}" [disabled]="viewOnly"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime 
                  id="pause-end-{{i}}"
                  presentation="time"
                  [(ngModel)]="slot.finePausa"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="viewOnly"
                  [hourCycle]="'h23'">
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>
        </div>
      </div>

      <ion-item button (click)="addSlot()" class="add-slot-button" *ngIf="!viewOnly">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        <ion-label>Aggiungi Fascia Oraria</ion-label>
      </ion-item>
    </ion-list>
  </form>

  <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
</ion-content>
